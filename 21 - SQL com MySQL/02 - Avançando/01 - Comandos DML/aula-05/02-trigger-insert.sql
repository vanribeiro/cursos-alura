-- Active: 1691456479247@@127.0.0.1@3306@vendas_sucos

CREATE TABLE TAB_FATURAMENTO(
    DATA_VENDA DATE NULL,
    TOTAL_VENDA FLOAT
);

DELETE FROM itens_notas;
DELETE FROM notas;

INSERT INTO notas (NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES ('0100', '2023-08-15', '1471156710', '235', 0.10);

INSERT INTO itens_notas (NUMERO, CODIGO, QUANTIDADE, PRECO) 
VALUES
    ('0100', '1000889', '100', '10'),
    ('0100', '1002334', '100', '10');

INSERT INTO notas (NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES ('0101', '2023-08-15', '1471156710', '235', 0.10);

INSERT INTO itens_notas (NUMERO, CODIGO, QUANTIDADE, PRECO) 
VALUES
    ('0101', '1000889', '100', '10'),
    ('0101', '1002334', '100', '10');

INSERT INTO notas (NUMERO, DATA_VENDA, CPF, MATRICULA, IMPOSTO)
VALUES ('0102', '2023-08-15', '1471156710', '235', 0.10);

INSERT INTO itens_notas (NUMERO, CODIGO, QUANTIDADE, PRECO) 
VALUES
    ('0102', '1000889', '100', '12'),
    ('0102', '1002334', '100', '12');

SELECT NF.DATA_VENDA, 
    SUM(INF.QUANTIDADE * INF.PRECO) AS TOTAL_VENDAS 
    FROM notas NF INNER JOIN itens_notas INF
    ON NF.NUMERO = INF.NUMERO
    GROUP BY NF.DATA_VENDA;

INSERT INTO tab_faturamento
    SELECT NF.DATA_VENDA, 
    SUM(INF.QUANTIDADE * INF.PRECO) AS TOTAL_VENDAS 
    FROM notas NF INNER JOIN itens_notas INF
    ON NF.NUMERO = INF.NUMERO
    GROUP BY NF.DATA_VENDA;

SELECT * FROM tab_faturamento;

DELETE FROM tab_faturamento;

-----------------------------------

DELIMITER //

CREATE TRIGGER TG_CALCULA_FATURAMENTO_INSERT AFTER INSERT ON ITENS_NOTAS
FOR EACH ROW BEGIN
    
    DELETE FROM tab_faturamento;

    INSERT INTO tab_faturamento
        SELECT NF.DATA_VENDA, 
        SUM(INF.QUANTIDADE * INF.PRECO) AS TOTAL_VENDAS 
        FROM notas NF INNER JOIN itens_notas INF
        ON NF.NUMERO = INF.NUMERO
        GROUP BY NF.DATA_VENDA;

END //